<script lang="coffee">
import Records        from '@/shared/services/records'
import EventBus       from '@/shared/services/event_bus'
import AbilityService from '@/shared/services/ability_service'
import ModalService   from '@/shared/services/modal_service'
import GroupModalMixin from '@/mixins/group_modal'
import { truncate } from 'lodash'

export default
  mixins: [GroupModalMixin]

  data: ->
    group: Records.groups.fuzzyFind(@$route.params.key)
    fragment: ''
    subgroups: []
    loading: true

  created: ->
    EventBus.$emit 'currentComponent',
      page: 'groupPage'
      title: @group.name
      group: @group

    Records.groups.fetchByParent(@group).then =>
      @loading = false
      EventBus.$emit 'subgroupsLoaded', @group

    @watchRecords
      collections: ['memberships', 'groups']
      query: (store) =>
        @subgroups = store.groups.collection.chain().
                       find(parentId: @group.id).
                       simplesort('name').data()

  computed:
    canCreateSubgroups: ->
      AbilityService.canCreateSubgroups(@group)

  methods:
    startSubgroup: ->
      @openStartSubgroupModal(@group)

    stripDescription: (description = '') -> (description).replace(///<[^>]*>?///gm, '')
</script>

<template lang="pug">
div
  v-layout.my-2(align-center)
    v-spacer
    v-btn.subgroups-card__start(color="primary" @click='startSubgroup()' v-if='canCreateSubgroups' v-t="'common.action.add_subgroup'")

  v-card.group-subgroups-panel(outlined)
    v-list(avatar two-line)
      v-list-item.subgroups-card__list-item(v-for='group in subgroups', :key='group.id' :to='urlFor(group)')
        v-list-item-avatar.subgroups-card__list-item-logo
          group-avatar(:group="group" size="28px")
        v-list-item-content
          v-list-item-title {{ group.name }}
          v-list-item-subtitle {{ stripDescription(group.description) }}
</template>
